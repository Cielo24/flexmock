

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Usage Documentation &mdash; Flexmock 0.9.4 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.9.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Flexmock 0.9.4 documentation" href="index.html" />
    <link rel="next" title="flexmock API" href="api.html" />
    <link rel="prev" title="Start Here" href="start.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="api.html" title="flexmock API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="start.html" title="Start Here"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Flexmock 0.9.4 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="usage-documentation">
<h1>Usage Documentation<a class="headerlink" href="#usage-documentation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="definitions">
<h2>Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h2>
<p>In order to discuss flexmock usage it&#8217;s important to define the
following terms.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Stub:</th><td class="field-body">fake object that returns a canned value</td>
</tr>
<tr class="field-even field"><th class="field-name">Mock:</th><td class="field-body">fake object that returns a canned value and has an expectation, i.e. it includes a built-in assertion</td>
</tr>
<tr class="field-odd field"><th class="field-name">Spy:</th><td class="field-body">watches method calls and records/verifies if the method is called with required parameters and/or returns expected values/exceptions</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>flexmock declarations follow a consistent style of the follow 3 forms:</p>
<dl class="docutils">
<dt>::</dt>
<dd><p class="first">flexmock ( OBJECT ).COMMAND( ATTRIBUTE ).MODIFIER[.MODIFIER, ...]</p>
<ul class="simple">
<li>or -</li>
</ul>
<p>flexmock ( OBJECT [, ATTRIBUTE=VALUE, ...] )</p>
<ul class="simple">
<li>or -</li>
</ul>
<p>flexmock ( ATTRIBUTE=VALUE [, ATTRIBUTE=VALUE,...] )</p>
<p>OBJECT:</p>
<blockquote>
<div>Either a module, a class, or an instance of a class</div></blockquote>
<p>COMMAND:</p>
<blockquote>
<div>One of should_receive, should_call, or new_instances. These
create the initial expectation object.</div></blockquote>
<p>ATTRIBUTE:</p>
<blockquote>
<div>String name of an attribute</div></blockquote>
<p>MODIFIER:</p>
<blockquote>
<div>One of several Expectation modifiers, such as with_args,
and_return, should_raise, times, etc.</div></blockquote>
<p>VALUE:</p>
<blockquote class="last">
<div>Anything</div></blockquote>
</dd>
</dl>
</div>
</div>
<hr class="docutils" />
<div class="section" id="example-usage">
<h1>Example Usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h1>
<div class="section" id="import-flexmock">
<h2>Import flexmock<a class="headerlink" href="#import-flexmock" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flexmock</span> <span class="kn">import</span> <span class="n">flexmock</span>
</pre></div>
</div>
</div>
<div class="section" id="make-a-fake-object">
<h2>Make a fake object<a class="headerlink" href="#make-a-fake-object" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fake</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">()</span>  <span class="c"># creates an object with no attributes</span>
</pre></div>
</div>
<p>Specify attribute/return value pairs</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fake_plane</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s">&quot;MIG-16&quot;</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="s">&quot;used&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Specify methods/return value pairs</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fake_plane</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span>
    <span class="n">fly</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="s">&quot;voooosh!&quot;</span><span class="p">,</span>
    <span class="n">land</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="s">&quot;landed!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can mix method and non-method attributes by making the return value a lambda for callable attributes.</p>
<p>flexmock fake objects support the full range of flexmock commands but
differ from partial mocks (described below) in that should_receive()
can assign them new methods rather than being limited to acting on methods
they already possess.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fake_plane</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">fly</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="s">&quot;vooosh!&quot;</span><span class="p">)</span>
<span class="n">fake_plane</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&quot;land&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&quot;landed!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="partially-mock-or-stub-an-existing-object">
<h2>Partially mock or stub an existing object<a class="headerlink" href="#partially-mock-or-stub-an-existing-object" title="Permalink to this headline">¶</a></h2>
<p>flexmock provides three syntactic ways to hook into an existing object and overwrite its methods.</p>
<p>Mark the object as partially mocked, allowing it to be used to create new expectations</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
<span class="n">plane</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;vooosh!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">once</span><span class="p">()</span>
<span class="n">plane</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;land&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;landed!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">once</span><span class="p">()</span>
</pre></div>
</div>
<p>Equivalent syntax assigns the partially mocked object to a variable</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">plane</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
<span class="n">plane</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;vooosh!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">once</span><span class="p">()</span>
<span class="n">plane</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;land&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;landed!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">once</span><span class="p">()</span>
</pre></div>
</div>
<p>Or you can combine everything into one line if there is only one method to overwrite</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;vooosh!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">once</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also return the mock object after setting the expectations</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">plane</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;vooosh!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mock</span><span class="p">()</span>
</pre></div>
</div>
<p>Note the &#8220;mock&#8221; modifier above &#8211; the expectation chain returns an expectation otherwise</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">plane</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;land&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">()</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="s">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">NOTE:</th><td class="field-body">If you do not provide a with_args() modifier then any set of arguments, including none, will be matched.  However, if you specify with_args() the expectation will only match exactly zero arguments.</td>
</tr>
<tr class="field-even field"><th class="field-name">NOTE:</th><td class="field-body">If you do not provide a return value then None is returned by default. Thus, and_return() is equivalent to and_return(None) is equivalent to simply leaving off and_return.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="convenient-shorthand-for-partial-stubs">
<h2>Convenient shorthand for partial stubs<a class="headerlink" href="#convenient-shorthand-for-partial-stubs" title="Permalink to this headline">¶</a></h2>
<p>Instead of writing out the lengthy should_receive/and_return statements, you can
also use the handy shorthand approach of passing them in as key=value pairs
to the flexmock() function. For example, we can stub out two methods of the plane object
in the same call:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">fly</span><span class="o">=</span><span class="s">&#39;voooosh!&#39;</span><span class="p">,</span> <span class="n">land</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="s">&#39;bar&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>This approach is handy and quick but only limited to stubs, i.e.
it is not possible to further modify these kind of calls with any of
the usual modifiers described below.</p>
</div>
<div class="section" id="stub-out-a-method-for-all-instances-of-a-class">
<h2>Stub out a method for all instances of a class<a class="headerlink" href="#stub-out-a-method-for-all-instances-of-a-class" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">User</span><span class="p">:</span> <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">flexmock</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;get_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;Bill Clinton&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bubba</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bubba</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
<span class="go">&#39;Bill Clinton&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="create-automatically-checked-expectations">
<h2>Create automatically checked expectations<a class="headerlink" href="#create-automatically-checked-expectations" title="Permalink to this headline">¶</a></h2>
<p>Using the times(N) modifier, or its aliases &#8211; once, twice, never &#8211;
allows you to create expectations that will be automatically checked by
the test runner.</p>
<p>Ensure fly(&#8216;forward&#8217;) gets called exactly three times</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="s">&#39;forward&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">times</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>Ensure turn(&#8216;east&#8217;) gets called at least twice</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;turn&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="s">&#39;east&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">at_least</span><span class="p">()</span><span class="o">.</span><span class="n">twice</span><span class="p">())</span>
</pre></div>
</div>
<p>Ensure land(&#8216;airfield&#8217;) gets called at most once</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;land&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="s">&#39;airfield&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">at_most</span><span class="p">()</span><span class="o">.</span><span class="n">once</span><span class="p">())</span>
</pre></div>
</div>
<p>Ensure that crash(&#8216;boom!&#8217;) is never called</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;crash&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="s">&#39;boom!&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">never</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="raise-exceptions">
<h2>Raise exceptions<a class="headerlink" href="#raise-exceptions" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_raise</span><span class="p">(</span><span class="n">BadWeatherException</span><span class="p">))</span>
</pre></div>
</div>
<p>Or you can add a message to the exception being raised</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_raise</span><span class="p">(</span><span class="n">BadWeatherException</span><span class="p">,</span> <span class="s">&#39;Oh noes, rain!&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="add-a-spy-or-proxy-to-a-method">
<h2>Add a spy (or proxy) to a method<a class="headerlink" href="#add-a-spy-or-proxy-to-a-method" title="Permalink to this headline">¶</a></h2>
<p>In addition to stubbing out a given method and returning fake values,
flexmock also allows you to call the original method and make
expectations based on its return values/exceptions and the number of
times the method is called with the given arguments.</p>
<p>Matching specific arguments</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_call</span><span class="p">(</span><span class="s">&#39;repair&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">wing</span><span class="p">,</span> <span class="n">cockpit</span><span class="p">)</span>
    <span class="o">.</span><span class="n">once</span><span class="p">())</span>
</pre></div>
</div>
<p>Matching any arguments</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_call</span><span class="p">(</span><span class="s">&#39;turn&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">twice</span><span class="p">())</span>
</pre></div>
</div>
<p>Matching specific return values</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_call</span><span class="p">(</span><span class="s">&#39;land&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;landed!&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Matching a regular expression</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_call</span><span class="p">(</span><span class="s">&#39;land&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^la&#39;</span><span class="p">)))</span>
</pre></div>
</div>
<p>Match return values by class/type</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_call</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
</pre></div>
</div>
<p>Ensure that an appropriate exception is raised</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_call</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_raise</span><span class="p">(</span><span class="n">BadWeatherException</span><span class="p">))</span>
</pre></div>
</div>
<p>Check that the exception message matches your expectations</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_call</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_raise</span><span class="p">(</span><span class="n">BadWeatherException</span><span class="p">,</span> <span class="s">&#39;Oh noes, rain!&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Check that the exception message matches a regular expression</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_call</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_raise</span><span class="p">(</span><span class="n">BadWeatherException</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;rain&#39;</span><span class="p">)))</span>
</pre></div>
</div>
<p>If either and_return() or and_raise() is provided, flexmock will
verify that the return value matches the expected return value or
exception.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">NOTE:</th><td class="field-body">should_call() changes the behavior of and_return() and and_raise() to specify expectations rather than generate given values or exceptions.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="return-different-values-on-successive-method-invocations">
<h2>Return different values on successive method invocations<a class="headerlink" href="#return-different-values-on-successive-method-invocations" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">flexmock</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;get_member&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;user1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;user2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;user3&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">group</span><span class="o">.</span><span class="n">get_member</span><span class="p">()</span>
<span class="go">&#39;user1&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">group</span><span class="o">.</span><span class="n">get_member</span><span class="p">()</span>
<span class="go">&#39;user2&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">group</span><span class="o">.</span><span class="n">get_member</span><span class="p">()</span>
<span class="go">&#39;user3&#39;</span>
</pre></div>
</div>
<p>Or use the short-hand form</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;get_member&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;user1&#39;</span><span class="p">,</span> <span class="s">&#39;user2&#39;</span><span class="p">,</span> <span class="s">&#39;user3&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">one_by_one</span><span class="p">())</span>
</pre></div>
</div>
<p>You can also mix return values with exception raises</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;get_member&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;user1&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;user2&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="override-new-method-on-a-class-and-return-fake-instances">
<h2>Override &#8220;__new__&#8221; method on a class and return fake instances<a class="headerlink" href="#override-new-method-on-a-class-and-return-fake-instances" title="Permalink to this headline">¶</a></h2>
<p>Occasionally you will want a class to create fake objects when it&#8217;s
being instantiated. flexmock makes it easy and painless.</p>
<p>Your first option is to simply replace the class with a function.</p>
<dl class="docutils">
<dt>::</dt>
<dd><dl class="first docutils">
<dt>(flexmock(some_module)</dt>
<dd>.should_receive(&#8216;NameOfClass&#8217;)
.and_return(fake_instance))</dd>
</dl>
<p class="last"># fake_instance can be created with flexmock as well</p>
</dd>
</dl>
<p>The upside of this approach is that it works for both new-style and old-style
classes. The downside is that you may run into subtle issues since the
class has now been replaced by a function.</p>
<p>If you&#8217;re dealing with new-style classes, flexmock offers another alternative using the .new_instances() command.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fake_group</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fake&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">flexmock</span><span class="p">(</span><span class="n">Group</span><span class="p">)</span><span class="o">.</span><span class="n">new_instances</span><span class="p">(</span><span class="n">fake_group</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Group</span><span class="p">()</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;fake&#39;</span>
<span class="go">True</span>
</pre></div>
</div>
<p>It is also possible to return different fake objects in a sequence.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fake_group1</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fake&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fake_group2</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;real&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">flexmock</span><span class="p">(</span><span class="n">Group</span><span class="p">)</span><span class="o">.</span><span class="n">new_instances</span><span class="p">(</span><span class="n">fake_group1</span><span class="p">,</span> <span class="n">fake_group2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Group</span><span class="p">()</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;fake&#39;</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Group</span><span class="p">()</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;real&#39;</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Another approach, if you&#8217;re familiar with how instance instatiation is done in Python, is to stub the __new__ method.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">flexmock</span><span class="p">(</span><span class="n">Group</span><span class="p">)</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;__new__&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">fake_group</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># or, if you want to be even slicker</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">flexmock</span><span class="p">(</span><span class="n">Group</span><span class="p">,</span> <span class="n">__new__</span><span class="o">=</span><span class="n">fake_group</span><span class="p">)</span>
</pre></div>
</div>
<p>In fact, the new_instances command is simply shorthand for should_receive(&#8216;__new__&#8217;).and_return() under the hood.</p>
</div>
<div class="section" id="create-a-mock-generator">
<h2>Create a mock generator<a class="headerlink" href="#create-a-mock-generator" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;flight_log&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_yield</span><span class="p">(</span><span class="s">&#39;take off&#39;</span><span class="p">,</span> <span class="s">&#39;flight&#39;</span><span class="p">,</span> <span class="s">&#39;landing&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">plane</span><span class="o">.</span><span class="n">flight_log</span><span class="p">():</span>
<span class="gp">&gt;&gt;&gt; </span>  <span class="k">print</span> <span class="n">i</span>
<span class="go">&#39;take off&#39;</span>
<span class="go">&#39;flight&#39;</span>
<span class="go">&#39;landing&#39;</span>
</pre></div>
</div>
<p>You can also use Python&#8217;s builtin iter() function to generate an iterable return value.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">flight_log</span><span class="o">=</span><span class="nb">iter</span><span class="p">([</span><span class="s">&#39;take off&#39;</span><span class="p">,</span> <span class="s">&#39;flight&#39;</span><span class="p">,</span> <span class="s">&#39;landing&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="section" id="private-methods">
<h2>Private methods<a class="headerlink" href="#private-methods" title="Permalink to this headline">¶</a></h2>
<p>One of the small pains of writing unit tests is that it can be
difficult to get at the private methods since Python &#8220;conveniently&#8221;
renames them when you try to access them from outside the object. With
flexmock there is nothing special you need to do to &#8211; mocking private
methods is exactly the same as any other methods.</p>
</div>
<div class="section" id="enforcing-call-order">
<h2>Enforcing call order<a class="headerlink" href="#enforcing-call-order" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="s">&#39;forward&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">ordered</span><span class="p">())</span>
<span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="s">&#39;up&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">ordered</span><span class="p">())</span>
</pre></div>
</div>
<p>Now if method fly() is called with the right arguments in the declared order things will be fine and both will return &#8216;ok&#8217;.
But trying to call fly(&#8216;up&#8217;) before fly(&#8216;forward&#8217;) will result in an exception.</p>
</div>
<div class="section" id="state-support">
<h2>State Support<a class="headerlink" href="#state-support" title="Permalink to this headline">¶</a></h2>
<p>flexmock supports conditional method execution based on external state. Consider a Radio class with the following methods:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Radio</span><span class="p">:</span>
<span class="gp">... </span>  <span class="n">is_on</span> <span class="o">=</span> <span class="bp">False</span>
<span class="gp">... </span>  <span class="k">def</span> <span class="nf">switch_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_on</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">... </span>  <span class="k">def</span> <span class="nf">switch_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_on</span> <span class="o">=</span> <span class="bp">False</span>
<span class="gp">... </span>  <span class="k">def</span> <span class="nf">select_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">None</span>
<span class="gp">... </span>  <span class="k">def</span> <span class="nf">adjust_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">num</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">radio</span> <span class="o">=</span> <span class="n">Radio</span><span class="p">()</span>
</pre></div>
</div>
<p>Now we can define some method call expectations dependent on the state of the radio:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">flexmock</span><span class="p">(</span><span class="n">radio</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">radio</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;select_channel&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">once</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">radio</span><span class="o">.</span><span class="n">is_on</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">radio</span><span class="o">.</span><span class="n">should_call</span><span class="p">(</span><span class="s">&#39;adjust_volume&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">once</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">radio</span><span class="o">.</span><span class="n">is_on</span><span class="p">)</span>
</pre></div>
</div>
<p>Calling these while the radio is off will result in an error:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">radio</span><span class="o">.</span><span class="n">select_channel</span><span class="p">()</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">&quot;flexmock.py&quot;</span>, line <span class="m">674</span>, in <span class="n">mock_method</span>
    <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">expectation</span><span class="o">.</span><span class="n">_get_runnable</span><span class="p">()))</span>
<span class="gr">flexmock.StateError</span>: <span class="n">select_channel expected to be called when condition is True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">radio</span><span class="o">.</span><span class="n">adjust_volume</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">&quot;flexmock.py&quot;</span>, line <span class="m">674</span>, in <span class="n">mock_method</span>
    <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">expectation</span><span class="o">.</span><span class="n">_get_runnable</span><span class="p">()))</span>
<span class="gr">flexmock.StateError</span>: <span class="n">adjust_volume expected to be called when condition is True</span>
</pre></div>
</div>
<p>Turning the radio on will make things work as expected:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">radio</span><span class="o">.</span><span class="n">is_on</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">radio</span><span class="o">.</span><span class="n">select_channel</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">radio</span><span class="o">.</span><span class="n">adjust_volume</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="chained-methods">
<h2>Chained methods<a class="headerlink" href="#chained-methods" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s say you have some code that looks something like the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">http</span> <span class="o">=</span> <span class="n">HTTP</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s">&#39;http://www.google.com&#39;</span><span class="p">)</span>
              <span class="o">.</span><span class="n">parse_html</span><span class="p">()</span>
              <span class="o">.</span><span class="n">display_results</span><span class="p">())</span>
</pre></div>
</div>
<p>You could use flexmock to mock each of these method calls individually:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">mock</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">get_url</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">parse_html</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">display_results</span><span class="o">=</span><span class="s">&#39;ok&#39;</span><span class="p">)))</span>
<span class="n">flexmock</span><span class="p">(</span><span class="n">HTTP</span><span class="p">)</span><span class="o">.</span><span class="n">new_instances</span><span class="p">(</span><span class="n">mock</span><span class="p">)</span>
</pre></div>
</div>
<p>But that looks really error prone and quite difficult to parse when
reading. Here&#8217;s a better way:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">mock</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">()</span>
<span class="n">flexmock</span><span class="p">(</span><span class="n">HTTP</span><span class="p">)</span><span class="o">.</span><span class="n">new_instances</span><span class="p">(</span><span class="n">mock</span><span class="p">)</span>
<span class="n">mock</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;get_url.parse_html.display_results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>When using this short-hand, flexmock will create intermediate objects
and expectations, returning the final one in the chain. As a result, any
further modifications, such as with_args() or times() modifiers, will
only be applied to the final method in the chain. If you need finer
grained control, such as specifying specific arguments to an
intermediate method, you can always fall back to the above long version.</p>
<p>Word of caution: because flexmock generates temporary intermediate mock objects
for each step along the chain, trying to mock two method call chains with the
same prefix will not work. That is, doing the following will fail to set up
the stub for display_results() because the one for save_results() overwrites it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">flexmock</span><span class="p">(</span><span class="n">HTTP</span><span class="p">)</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;get_url.parse_html.display_results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
<span class="n">flexmock</span><span class="p">(</span><span class="n">HTTP</span><span class="p">)</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;get_url.parse_html.save_results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this situation, you should identify the point where the chain starts to
diverge and return a flexmock() object that handles all the &#8220;tail&#8221;
methods using the same object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">HTTP</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;get_url.parse_html&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">flexmock</span><span class="p">,</span> <span class="n">display_results</span><span class="o">=</span><span class="s">&#39;ok&#39;</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="s">&#39;ok&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="replacing-methods-with-custom-functions">
<h2>Replacing methods with custom functions<a class="headerlink" href="#replacing-methods-with-custom-functions" title="Permalink to this headline">¶</a></h2>
<p>There are times when it is useful to replace a method with a custom lambda or function in order to return custom values based on provided arguments or a global value that changes between method calls.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;set_speed&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">replace_with</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
<p>There is also shorthand for this, similar to the shorthand for should_receive/and_return:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">set_speed</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">NOTE:</th><td class="field-body">Whenever the return value provided to the key=value shorthand is a callable (such as lambda), flexmock expands it to should_receive().replace_with() rather than and_return().</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="mocking-builtin-functions">
<h2>Mocking builtin functions<a class="headerlink" href="#mocking-builtin-functions" title="Permalink to this headline">¶</a></h2>
<p>Mocking or stubbing out builtin functions, such as open(), can be slightly tricky.
The &#8220;builtins&#8221; module is accessed differenty in interactive Python sessions versus
running applications and named differently in Python 3.0 and above.
It is also not always obvious when the builtin function you are trying to mock might be
internally called by the test runner and cause unexpected behavior in the test.
As a result, the recommended way to mock out builtin functions is to always specify
a fall-through with should_call() first and use with_args() to limit the scope of
your mock or stub to just the specific invocation you are trying to replace:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># python 2.4+</span>
<span class="n">mock</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;__builtin__&#39;</span><span class="p">])</span>
<span class="n">mock</span><span class="o">.</span><span class="n">should_call</span><span class="p">(</span><span class="s">&#39;open&#39;</span><span class="p">)</span>  <span class="c"># set the fall-through</span>
<span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;open&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="s">&#39;/your/file&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">read</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="s">&#39;file contents&#39;</span><span class="p">)</span> <span class="p">))</span>

<span class="c"># python 3.0+</span>
<span class="n">mock</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;builtins&#39;</span><span class="p">])</span>
<span class="n">mock</span><span class="o">.</span><span class="n">should_call</span><span class="p">(</span><span class="s">&#39;open&#39;</span><span class="p">)</span>  <span class="c"># set the fall-through</span>
<span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;open&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="s">&#39;/your/file&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span> <span class="n">flexmock</span><span class="p">(</span><span class="n">read</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="s">&#39;file contents&#39;</span><span class="p">)</span> <span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="expectation-matching">
<h1>Expectation Matching<a class="headerlink" href="#expectation-matching" title="Permalink to this headline">¶</a></h1>
<p>Creating an expectation with no arguments will by default match all
arguments, including no arguments.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Will be matched by any of the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">plane</span><span class="o">.</span><span class="n">fly</span><span class="p">()</span>
<span class="go">&#39;ok&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plane</span><span class="o">.</span><span class="n">fly</span><span class="p">(</span><span class="s">&#39;up&#39;</span><span class="p">)</span>
<span class="go">&#39;ok&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plane</span><span class="o">.</span><span class="n">fly</span><span class="p">(</span><span class="s">&#39;up&#39;</span><span class="p">,</span> <span class="s">&#39;down&#39;</span><span class="p">)</span>
<span class="go">&#39;ok&#39;</span>
</pre></div>
</div>
<p>You can also match exactly no arguments</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">())</span>
</pre></div>
</div>
<p>Or match any single argument</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="nb">object</span><span class="p">))</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">NOTE:</th><td class="field-body">In addition to exact values, you can match against the type or class of the argument.</td>
</tr>
</tbody>
</table>
<p>Match any single string argument</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</pre></div>
</div>
<p>Match the empty string using a compiled regular expression</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^(up|down)$&#39;</span><span class="p">)</span> <span class="p">))</span>
</pre></div>
</div>
<p>Match any set of three arguments where the first one is an integer,
second one is anything, and third is string &#8216;foo&#8217;
(matching against user defined classes is also supported in the same fashion)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;repair&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="s">&#39;notes&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>And if the default argument matching based on types is not flexible enough,
flexmock will respect matcher objects that provide a custom __eq__ method.</p>
<p>For example, when trying to match against contents of numpy arrays,
equality is undefined by the library so comparing two of them directly
is meaningless unless you use all() or any() on the return value of the comparison.</p>
<p>What you can do in this case is create a custom matcher object and flexmock will
use its __eq__ method when comparing the arguments at runtime.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NumpyArrayMatcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">array</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">other</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>

<span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;function&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">ArrayMatcher</span><span class="p">(</span><span class="n">array1</span><span class="p">)))</span>
</pre></div>
</div>
<p>The above approach will work for any objects that choose not to return proper
comparison values, or if you simply find the default equality and
type-based matching too restrictive.</p>
<p>It is, of course, also possible to create multiple expectations for the same
method differentiated by arguments.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="s">&#39;up&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;bad&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plane</span><span class="o">.</span><span class="n">fly</span><span class="p">()</span>
<span class="go">&#39;ok&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plane</span><span class="o">.</span><span class="n">fly</span><span class="p">(</span><span class="s">&#39;forward&#39;</span><span class="p">,</span> <span class="s">&#39;down&#39;</span><span class="p">)</span>
<span class="go">&#39;ok&#39;</span>
</pre></div>
</div>
<p>But!</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">plane</span><span class="o">.</span><span class="n">fly</span><span class="p">(</span><span class="s">&#39;up&#39;</span><span class="p">)</span>
<span class="go">&#39;bad&#39;</span>
</pre></div>
</div>
<p>The order of the expectations being defined is significant, with later
expectations having higher precedence than previous ones. Which means
that if you reversed the order of the example expectations above the
more specific expectation would never be matched.</p>
<p>In the example above, the first expectation on the fly() method did not
specify any arguments and so matches any calls to that method. The second
one is more specific and only takes effect when the method is called with
the specified arguments.</p>
</div>
<div class="section" id="style">
<h1>Style<a class="headerlink" href="#style" title="Permalink to this headline">¶</a></h1>
<p>While the order of modifiers is unimportant to flexmock, there is a preferred convention
that will make your tests more readable.</p>
<p>If using with_arg(), place it before should_return():</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="s">&#39;up&#39;</span><span class="p">,</span> <span class="s">&#39;down&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>If using the times() modifier (or its aliases: once, twice, never), place them at
the end of the flexmock statement:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">flexmock</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="s">&#39;fly&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">once</span><span class="p">())</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Usage Documentation</a><ul>
<li><a class="reference internal" href="#definitions">Definitions</a></li>
<li><a class="reference internal" href="#overview">Overview</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-usage">Example Usage</a><ul>
<li><a class="reference internal" href="#import-flexmock">Import flexmock</a></li>
<li><a class="reference internal" href="#make-a-fake-object">Make a fake object</a></li>
<li><a class="reference internal" href="#partially-mock-or-stub-an-existing-object">Partially mock or stub an existing object</a></li>
<li><a class="reference internal" href="#convenient-shorthand-for-partial-stubs">Convenient shorthand for partial stubs</a></li>
<li><a class="reference internal" href="#stub-out-a-method-for-all-instances-of-a-class">Stub out a method for all instances of a class</a></li>
<li><a class="reference internal" href="#create-automatically-checked-expectations">Create automatically checked expectations</a></li>
<li><a class="reference internal" href="#raise-exceptions">Raise exceptions</a></li>
<li><a class="reference internal" href="#add-a-spy-or-proxy-to-a-method">Add a spy (or proxy) to a method</a></li>
<li><a class="reference internal" href="#return-different-values-on-successive-method-invocations">Return different values on successive method invocations</a></li>
<li><a class="reference internal" href="#override-new-method-on-a-class-and-return-fake-instances">Override &#8220;__new__&#8221; method on a class and return fake instances</a></li>
<li><a class="reference internal" href="#create-a-mock-generator">Create a mock generator</a></li>
<li><a class="reference internal" href="#private-methods">Private methods</a></li>
<li><a class="reference internal" href="#enforcing-call-order">Enforcing call order</a></li>
<li><a class="reference internal" href="#state-support">State Support</a></li>
<li><a class="reference internal" href="#chained-methods">Chained methods</a></li>
<li><a class="reference internal" href="#replacing-methods-with-custom-functions">Replacing methods with custom functions</a></li>
<li><a class="reference internal" href="#mocking-builtin-functions">Mocking builtin functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#expectation-matching">Expectation Matching</a></li>
<li><a class="reference internal" href="#style">Style</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="start.html"
                        title="previous chapter">Start Here</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="api.html"
                        title="next chapter">flexmock API</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/user-guide.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="api.html" title="flexmock API"
             >next</a> |</li>
        <li class="right" >
          <a href="start.html" title="Start Here"
             >previous</a> |</li>
        <li><a href="index.html">Flexmock 0.9.4 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Herman Sheremetyev.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>